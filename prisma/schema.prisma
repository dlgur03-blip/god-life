datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

generator client {
  provider = "prisma-client-js"
  previewFeatures = ["driverAdapters"]
}

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String?
  image         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  destinyDays       DestinyDay[]
  destinyEvents     DestinyEvent[]
  destinyTemplates  DestinyTemplate[]
  successProjects   SuccessProject[]
  disciplineRules   DisciplineRule[]
  epistleDays       EpistleDay[]
  weeklyPlans       WeeklyPlan[]
  errorLogs         ErrorLog[]
  goals             Goal[]
}

// M3: Destiny Navigator
model DestinyDay {
  id        String   @id @default(cuid())
  date      String   // YYYY-MM-DD
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Goals
  goalUltimate String?
  goalLong     String?
  goalMonth    String?
  goalWeek     String?
  goalToday    String?

  timeblocks DestinyTimeBlock[]
  events     DestinyEvent[] // Events linked to a day

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, date])
}

model DestinyTimeBlock {
  id            String     @id @default(cuid())
  dayId         String
  day           DestinyDay @relation(fields: [dayId], references: [id], onDelete: Cascade)

  seq           Int        // Now supports 1..N (no upper limit)
  startTime     String     @default("00:00")  // REQUIRED - no longer optional
  endTime       String     @default("01:00")  // REQUIRED - no longer optional

  planText      String?
  planLocation  String?

  actualText    String?
  score         Int?       // 0..10
  feedback      String?

  status        String     @default("planned")

  updatedAt     DateTime   @updatedAt

  @@unique([dayId, seq])
}

// Destiny Timeblock Templates
model DestinyTemplate {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  name      String   // Template name (e.g., 'Weekday Routine', 'Weekend Routine')
  blocks    Json     // Array of {seq, startTime, endTime, planText, planLocation}

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, name])
}

// M4: Events
model DestinyEvent {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  dayId       String?
  day         DestinyDay? @relation(fields: [dayId], references: [id])

  title       String
  recordedAt  DateTime @default(now())
  
  createdAt   DateTime @default(now())
}

// M5: Success Code
model SuccessProject {
  id           String   @id @default(cuid())
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  title        String
  startDate    DateTime
  reminderTime String?  // "09:00"
  enabled      Boolean  @default(true)

  entries      SuccessEntry[]

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model SuccessEntry {
  id          String         @id @default(cuid())
  projectId   String
  project     SuccessProject @relation(fields: [projectId], references: [id], onDelete: Cascade)

  dayIndex    Int            // 1..100
  content     String?
  imageUrl    String?        // M6
  
  isCompleted Boolean        @default(false)
  completedAt DateTime?

  updatedAt   DateTime       @updatedAt

  @@unique([projectId, dayIndex])
}

// M7: Discipline Mastery
model DisciplineRule {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  title     String
  sortOrder Int      @default(0)

  checks    DisciplineCheck[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model DisciplineCheck {
  id        String         @id @default(cuid())
  ruleId    String
  rule      DisciplineRule @relation(fields: [ruleId], references: [id], onDelete: Cascade)

  date      String         // YYYY-MM-DD
  checkedAt DateTime       @default(now())

  @@unique([ruleId, date])
}

// M8: Self Epistle
model EpistleDay {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  date        String   // YYYY-MM-DD
  toYesterday String?  // Letter to yesterday
  toTomorrow  String?  // Letter to tomorrow
  mood        String?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([userId, date])
}

// Weekly Plan - 7 free-form slots
model WeeklyPlan {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  slot      Int      // 0-6 (7 slots)
  content   String   // Free-form content

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, slot])
}

// M9: Bio Hacking (Global Content with Translations)
model BioPost {
  id        String   @id @default(cuid())
  slug      String   @unique
  category  String

  translations BioPostTranslation[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model BioPostTranslation {
  id        String   @id @default(cuid())
  postId    String
  post      BioPost  @relation(fields: [postId], references: [id], onDelete: Cascade)

  locale    String   // 'ko' | 'en' | 'ja'
  title     String
  content   String   // Markdown

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([postId, locale])
}

// Error Logging
model ErrorLog {
  id            String   @id @default(cuid())
  level         String   // 'error' | 'warning' | 'info'
  message       String
  stack         String?  // Max 5000 chars (truncated on save)
  userId        String?
  user          User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  requestUrl    String?
  requestMethod String?
  createdAt     DateTime @default(now())

  @@index([level])
  @@index([createdAt])
  @@index([userId])
}

// Goal Type Enum
enum GoalType {
  ULTIMATE    // 궁극의 목표
  TEN_YEAR    // 10년 목표
  FIVE_YEAR   // 5년 목표
  ONE_YEAR    // 1년 목표
  SIX_MONTH   // 6개월 목표
  THREE_MONTH // 3개월 목표
  ONE_MONTH   // 1개월 목표
  ONE_WEEK    // 1주 목표
}

// Goal Status Enum
enum GoalStatus {
  ACTIVE
  COMPLETED
  PAUSED
  CANCELLED
}

// Goal Model with self-referential hierarchy
model Goal {
  id          String     @id @default(cuid())
  userId      String
  user        User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  type        GoalType
  title       String
  description String?

  // Self-referential hierarchy
  parentId    String?
  parent      Goal?      @relation("GoalHierarchy", fields: [parentId], references: [id], onDelete: SetNull)
  children    Goal[]     @relation("GoalHierarchy")

  // Dates
  startDate   DateTime?
  targetDate  DateTime?

  // Progress tracking (0-100)
  progress    Int        @default(0)
  status      GoalStatus @default(ACTIVE)

  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  @@index([userId])
  @@index([userId, type])
  @@index([parentId])
}